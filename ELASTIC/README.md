# HOMEWORK_ELASTIC_6_5_(VITKIN_K_N)

### 1.

- *Cоставим Dockerfile-манифест для elasticsearch*

```
FROM centos:7
RUN adduser -mr elastic && mkdir /var/lib/elastic && chown elastic /var/lib/elastic
USER elastic
RUN cd && curl -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.2.2-linux-x86_64.tar.gz && tar -xzf elasticsearch-8.2.2-linux-x86_64.tar.gz && rm elasticsearch-8.2.2-linux-x86_64.tar.gz
ENV JOB_DIRECT=./elasticsearch-8.2.2
RUN cd && echo "node.name: netology_test" >> $JOB_DIRECT/config/elasticsearch.yml && echo "path.data: /var/lib/elastic" >> $JOB_DIRECT/config/elasticsearch.yml
EXPOSE 9200
CMD $HOME/$JOB_DIRECT/bin/elasticsearch
```

- *Cоберите docker-образ и сделайте push в ваш docker.io репозиторий*
  ![](https://github.com/VitkinKN/HOMEWORKNETOLOGY/blob/master/IMAGES/21.png )

```
konstantin@konstantin-forever ~/DEVOPS_COURSE/TASK_6_5_ $ sudo docker tag c046d5507c92 vitkinkon/netology:CentOS_Elastic
konstantin@konstantin-forever ~/DEVOPS_COURSE/TASK_6_5_ $ sudo docker tag c046d5507c92 vitkinkon/netology:CentOS_Elastic
The push refers to repository [docker.io/vitkinkon/netology]
350ee13b8d66: Layer already exists 
2fbfe9b11d02: Pushed 
61eb6d7fdd92: Layer already exists 
174f56854903: Pushed 
CentOS_Elastic: digest: sha256:6b32900d3bd8b86f6c9b84aec024b43a98dcdc66d4673091cf7d27ae2fee09f6 size: 1158
```

##### *Ccылка на наш image:*

###### [Image in Hub.docker.com](https://hub.docker.com/layers/232497042/vitkinkon/netology/CentOS_Elastic/images/sha256-6b32900d3bd8b86f6c9b84aec024b43a98dcdc66d4673091cf7d27ae2fee09f6?context=repo)

- *Заходим в контейнер, и смотрим ответ elasticsearch на запрос пути / в json виде*

```
[elastic@f004b04d0e05 /]$ /home/elastic/elasticsearch-8.2.2/bin/elasticsearch-reset-password -u elastic
This tool will reset the password of the [elastic] user to an autogenerated value.
The password will be printed in the console.
Please confirm that you would like to continue [y/N]y
Password for the [elastic] user successfully reset.
New value: 6i+N7GzL=1_QhZvVTf1N
elastic@f004b04d0e05 /]$ curl -ku elastic https://localhost:9200
Enter host password for user 'elastic':
{
  "name" : "netology_test",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "EVzoo-zZQ2uSA4QPqZtZ7w",
  "version" : {
    "number" : "8.2.2",
    "build_flavor" : "default",
    "build_type" : "tar",
    "build_hash" : "9876968ef3c745186b94fdabd4483e01499224ef",
    "build_date" : "2022-05-25T15:47:06.259735307Z",
    "build_snapshot" : false,
    "lucene_version" : "9.1.0",
    "minimum_wire_compatibility_version" : "7.17.0",
    "minimum_index_compatibility_version" : "7.0.0"
  },
  "tagline" : "You Know, for Search"
}
```

---

### 2

- *Добавьте в elasticsearch 3 индекса, в соответствии со таблицей:*

```
[elastic@f004b04d0e05 /]$ curl -ku elastic -X PUT "https://localhost:9200/ind-1" -H 'Content-Type: application/json' -d'
> {
> "settings": {
> "index": {
> "number_of_shards": 1,
> "number_of_replicas": 0
> }
> }
> }
> '
Enter host password for user 'elastic':
{"acknowledged":true,"shards_acknowledged":true,"index":"ind-1"}

[elastic@f004b04d0e05 /]$ curl -ku elastic -X PUT "https://localhost:9200/ind-2" -H 'Content-Type: application/json' -d' 
> {
> "settings": {
> "index": {
> "number_of_shards": 2,
> "number_of_replicas": 1
> }
> }
> }
> '
Enter host password for user 'elastic':
{"acknowledged":true,"shards_acknowledged":true,"index":"ind-2"}[elastic@f004b04d0e05
[elastic@f004b04d0e05 /]$ curl -ku elastic -X PUT "https://localhost:9200/ind-3" -H 'Content-Type: application/json' -d'
> {
> "settings": {
> "index": {
> "number_of_shards": 4,
> "number_of_replicas": 2
> }
> }
> }
> '
Enter host password for user 'elastic':
{"acknowledged":true,"shards_acknowledged":true,"index":"ind-3"}
```

- *Получаем список индексов и их статусов, используя API*

```
[elastic@f004b04d0e05 /]$ curl -ku elastic  https://localhost:9200/_cat/indices
Enter host password for user 'elastic':
green  open ind-1 w1EWVjgqRgGxv3T7yseiUw 1 0 0 0 225b 225b
yellow open ind-3 dghQ-Nt0ReOO2B0anqprfA 4 2 0 0 900b 900b
yellow open ind-2 tqJRDEoDQ3i0nF3FF6I8qg 2 1 0 0 450b 450b
```

- *Получаем состояние кластера elasticsearch, используя API.*

```
[elastic@f004b04d0e05 /]$ curl -ku elastic  https://localhost:9200/_cluster/health?pretty
Enter host password for user 'elastic':
{
  "cluster_name" : "elasticsearch",
  "status" : "yellow",
  "timed_out" : false,
  "number_of_nodes" : 1,
  "number_of_data_nodes" : 1,
  "active_primary_shards" : 9,
  "active_shards" : 9,
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 10,
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 47.368421052631575
}
```

- *Так как реплики и шарды мы только что создали, значит они не являются поврежденными, тогда получается что в данных индексах отсутствуют («нераспределенные») сегменты реплик. В тех индексах где есть сегменты, но нет для них отдельнх нод являются нераспределённыи - yellow*
- *Удалите все индексы*

```
[elastic@f004b04d0e05 /]$ curl -ku elastic  -X DELETE https://localhost:9200/ind-1
Enter host password for user 'elastic':
{"acknowledged":true}
[elastic@f004b04d0e05 /]$ curl -ku elastic  -X DELETE https://localhost:9200/ind-2
Enter host password for user 'elastic':
{"acknowledged":true}
[elastic@f004b04d0e05 /]$ curl -ku elastic  -X DELETE https://localhost:9200/ind-3
Enter host password for user 'elastic':
{"acknowledged":true}[elastic@f004b04d0e05 /]$ 
```

---

### 3

- *Создаём директорию {путь до корневой директории с elasticsearch в образе}/snapshots.*

```
[elastic@f004b04d0e05 /]$ mkdir /home/elastic/elasticsearch-8.2.2/snapshots
[elastic@f004b04d0e05 /]$ mkdir /var/lib/elastic/snapshots
```

- *Используя API зарегистрируем данную директорию как snapshot repository c именем netology_backup. В elasticsearch.yml добавим директиву path.repo: /usr/share/elasticsearch/snapshots, сам запрос на регистрацию snapshot repo*

```
eelastic@f004b04d0e05 /]$ echo path.repo: [ "/var/lib/elastic/snapshots" ] >> /home/elastic/elasticsearch-8.2.2/config/elasticsearch.yml
[elastic@f004b04d0e05 /]$ chown elastic:elastic /home/elastic/elasticsearch-8.2.2/snapshots
chown elastic:elastic /var/lib/elastic/snapshots
konstantin@konstantin-forever ~/DEVOPS_COURSE/TASK_6_5_ $ sudo docker restart f004b04d0e05
[elastic@f004b04d0e05 /]$ curl -ku elastic -X PUT "https://localhost:9200/_snapshot/netology_backup?pretty" -H 'Content-Type: application/json' -d'
> {
> "type": "fs",
> "settings": { "location":"/var/lib/elastic/snapshots"
> }
> }
> '
Enter host password for user 'elastic':
{
  "acknowledged" : true
}
```
- *Создаём` индекс test с 0 реплик и 1 шардом и выводим список индексов*
```
[elastic@f004b04d0e05 /]$ curl -ku elastic -X PUT "https://localhost:9200/test" -H 'Content-Type: application/json' -d'
> {
> "settings": {
> "index": {
> "number_of_shards": 1,
> "number_of_replicas": 0
> }
> }
> }
> '
Enter host password for user 'elastic':
{"acknowledged":true,"shards_acknowledged":true,"index":"test"}

[elastic@f004b04d0e05 /]$ curl -ku elastic  https://localhost:9200/_cat/indices
Enter host password for user 'elastic':
green open test u6_HELclQb6NZ8IT11MrXA 1 0 0 0 225b 225b
```
- *Создаём snapshot состояния кластера elasticsearch. Приведим в ответе список файлов в директории со snapshotами*
```
[elastic@f004b04d0e05 /]$ curl -ku elastic -X PUT "https://localhost:9200/_snapshot/netology_backup/snapshot_1?wait_for_completion=true&pretty"
Enter host password for user 'elastic':
{
  "snapshot" : {
    "snapshot" : "snapshot_1",
    "uuid" : "byGfiWKTQ4OptcjYoI1mrQ",
    "repository" : "netology_backup",
    "version_id" : 8020299,
    "version" : "8.2.2",
    "indices" : [
      ".geoip_databases",
      ".security-7",
      "test"
    ],
    "data_streams" : [ ],
    "include_global_state" : true,
    "state" : "SUCCESS",
    "start_time" : "2022-06-13T17:16:37.819Z",
    "start_time_in_millis" : 1655140597819,
    "end_time" : "2022-06-13T17:16:42.021Z",
    "end_time_in_millis" : 1655140602021,
    "duration_in_millis" : 4202,
    "failures" : [ ],
    "shards" : {
      "total" : 3,
      "failed" : 0,
      "successful" : 3
    },
    "feature_states" : [
      {
        "feature_name" : "geoip",
        "indices" : [
          ".geoip_databases"
        ]
      },
      {
        "feature_name" : "security",
        "indices" : [
          ".security-7"
        ]
      }
    ]
  }
}

```
- *Cписок файлов в директории со snapshotами.*
```
konstantin@konstantin-forever ~/DEVOPS_COURSE/TASK_6_5_ $ sudo docker exec -it f004b04d0e05 ls -la /var/lib/elastic/snapshots/
[sudo] пароль для konstantin: 
total 44
drwxrwxr-x 3 elastic elastic  4096 Jun 13 17:16 .
drwxr-xr-x 1 elastic root     4096 Jun 13 17:21 ..
-rw-r--r-- 1 elastic elastic  1095 Jun 13 17:16 index-0
-rw-r--r-- 1 elastic elastic     8 Jun 13 17:16 index.latest
drwxr-xr-x 5 elastic elastic  4096 Jun 13 17:16 indices
-rw-r--r-- 1 elastic elastic 18330 Jun 13 17:16 meta-byGfiWKTQ4OptcjYoI1mrQ.dat
-rw-r--r-- 1 elastic elastic   386 Jun 13 17:16 snap-byGfiWKTQ4OptcjYoI1mrQ.dat
```
- *Удалим индекс test и создадим индекс test-2. Приведём список индексов.
```
[elastic@f004b04d0e05 /]$ curl -ku elastic -X DELETE "https://localhost:9200/test?pretty"
Enter host password for user 'elastic':
{
  "acknowledged" : true
}

[elastic@f004b04d0e05 /]$ curl -ku elastic -X DELETE "https://localhost:9200/test?pretty"
Enter host password for user 'elastic':
{
  "acknowledged" : true
}
[elastic@f004b04d0e05 /]$ curl -ku elastic -X PUT "https://localhost:9200/test-2" -H 'Content-Type: application/json' -d'
> {
> "settings": {
> "number_of_shards": 1,
> "number_of_replicas": 0
> }
> }
> '
Enter host password for user 'elastic':
{"acknowledged":true,"shards_acknowledged":true,"index":"test-2"}

[elastic@f004b04d0e05 /]$ curl -ku elastic  https://localhost:9200/_cat/indices
Enter host password for user 'elastic':
green open test-2 sG2SeRcvRR6Gsfg9equHcw 1 0 0 0 225b 225b

6i+N7GzL=1_QhZvVTf1N
```
- *Восстановим состояние кластера elasticsearch из snapshot, созданного ранее*
```
[elastic@f004b04d0e05 /]$ curl -ku elastic -X POST "https://localhost:9200/_snapshot/netology_backup/snapshot_1/_restore?pretty" -H 'Content-Type: application/json' -d'
> {
> "indices": "*",
> "include_global_state": true
> }
> '
Enter host password for user 'elastic':
{
  "accepted" : true
}
[elastic@f004b04d0e05 /]$ curl -ku elastic  https://localhost:9200/_cat/indices
Enter host password for user 'elastic':
green open test   SQmw1jDwT0CqAkek1FeA8A 1 0 0 0 225b 225b
green open test-2 sG2SeRcvRR6Gsfg9equHcw 1 0 0 0 225b 225b
```
---

